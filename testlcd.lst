0000              1   ; Daniel Ng ELEC291 Lab 1
0000              2   ; LCD_test_4bit.asm: Initializes and uses an LCD in 4-bit mode
0000              3   ; using the most common procedure found on the internet and datasheets.
                  5   $LIST
0000              7   
0000              8   org 0000H
0000 020097       9       ljmp myprogram
0003             10   
0003             11   ; vector address for ext0 and ext1
0003             12   org 0003H 
0003 020167      13       ljmp ISR_EXT0
0006             14   
0013             15   org 0013H
0013 020196      16       ljmp ISR_EXT1
0016             17   
0016             18   
0016             19   
0016             20   ;  N76E003 pinout:
0016             21   ;                               -------
0016             22   ;       PWM2/IC6/T0/AIN4/P0.5 -|1    20|- P0.4/AIN5/STADC/PWM3/IC3
0016             23   ;               TXD/AIN3/P0.6 -|2    19|- P0.3/PWM5/IC5/AIN6
0016             24   ;               RXD/AIN2/P0.7 -|3    18|- P0.2/ICPCK/OCDCK/RXD_1/[SCL]
0016             25   ;                    RST/P2.0 -|4    17|- P0.1/PWM4/IC4/MISO
0016             26   ;        INT0/OSCIN/AIN1/P3.0 -|5    16|- P0.0/PWM3/IC3/MOSI/T1
0016             27   ;              INT1/AIN0/P1.7 -|6    15|- P1.0/PWM2/IC2/SPCLK
0016             28   ;                         GND -|7    14|- P1.1/PWM1/IC1/AIN7/CLO
0016             29   ;[SDA]/TXD_1/ICPDA/OCDDA/P1.6 -|8    13|- P1.2/PWM0/IC0
0016             30   ;                         VDD -|9    12|- P1.3/SCL/[STADC]
0016             31   ;            PWM5/IC7/SS/P1.5 -|10   11|- P1.4/SDA/FB/PWM1
0016             32   ;                               -------
0016             33   ;
0016             34   
0016             35   ; These 'equ' must match the hardware wiring
0016             36   LCD_RS equ P1.3
0016             37   ;LCD_RW equ PX.X ; Not used in this code, connect the pin to GND
0016             38   LCD_E  equ P1.4
0016             39   LCD_D4 equ P0.0
0016             40   LCD_D5 equ P0.1
0016             41   LCD_D6 equ P0.2
0016             42   LCD_D7 equ P0.3
0016             43   
0016             44   ; When using a 16.6MHz oscillator in the N76E003
0016             45   ; one cycle takes 1.0/16.6MHz = 60.24 ns
0016             46   
0016             47   ;---------------------------------;
0016             48   ; Wait 40 microseconds            ;
0016             49   ;---------------------------------;
0016             50   Wait40uSec:
0016 C000        51       push AR0
0018 7885        52       mov R0, #133
001A             53   L0:
001A 00          54       nop
001B D8FD        55       djnz R0, L0 ; 1+4 cycles->5*60.24ns*133=40us // decrement and jump loop back (to L0) if Ro is not equal to zero
001D D000        56       pop AR0
001F 22          57       ret
0020             58   
0020             59   ;---------------------------------;
0020             60   ; Wait 'R2' milliseconds          ;
0020             61   ;---------------------------------;
0020             62   WaitmilliSec:
0020 C000        63       push AR0
0022 C001        64       push AR1
0024 7928        65   L3: mov R1, #40
0026 7868        66   L2: mov R0, #104
0028 D8FE        67   L1: djnz R0, L1 ; 4 cycles->4*60.24ns*104=25.0us
002A D9FA        68       djnz R1, L2 ; 25us*40=1.0ms
002C DAF6        69       djnz R2, L3 ; number of millisecons to wait passed in R2
002E D001        70       pop AR1
0030 D000        71       pop AR0
0032 22          72       ret
0033             73   
0033             74   ;---------------------------------;
0033             75   ; Toggles the LCD's 'E' pin       ;
0033             76   ;---------------------------------;
0033             77   LCD_pulse:
0033 D294        78       setb LCD_E
0035 120016      79       lcall Wait40uSec
0038 C294        80       clr LCD_E
003A 22          81       ret
003B             82   
003B             83   ;---------------------------------;
003B             84   ; Writes data to LCD              ;
003B             85   ;---------------------------------;
003B             86   WriteData:
003B D293        87       setb LCD_RS
003D 020045      88       ljmp LCD_byte
0040             89   
0040             90   ;---------------------------------;
0040             91   ; Writes command to LCD           ;
0040             92   ;---------------------------------;
0040             93   WriteCommand:
0040 C293        94       clr LCD_RS
0042 020045      95       ljmp LCD_byte
0045             96   
0045             97   ;---------------------------------;
0045             98   ; Writes acc to LCD in 4-bit mode ;
0045             99   ;---------------------------------;
0045            100   LCD_byte:
0045            101       ; Write high 4 bits first
0045 A2E7       102       mov c, ACC.7
0047 9283       103       mov LCD_D7, c
0049 A2E6       104       mov c, ACC.6
004B 9282       105       mov LCD_D6, c
004D A2E5       106       mov c, ACC.5
004F 9281       107       mov LCD_D5, c
0051 A2E4       108       mov c, ACC.4
0053 9280       109       mov LCD_D4, c
0055 120033     110       lcall LCD_pulse
0058            111   
0058            112       ; Write low 4 bits next
0058 A2E3       113       mov c, ACC.3
005A 9283       114       mov LCD_D7, c
005C A2E2       115       mov c, ACC.2
005E 9282       116       mov LCD_D6, c
0060 A2E1       117       mov c, ACC.1
0062 9281       118       mov LCD_D5, c
0064 A2E0       119       mov c, ACC.0
0066 9280       120       mov LCD_D4, c
0068 120033     121       lcall LCD_pulse
006B 22         122       ret
006C            123   
006C            124   ;---------------------------------;
006C            125   ; Configure LCD in 4-bit mode     ;
006C            126   ;---------------------------------;
006C            127   LCD_4BIT:
006C C294       128       clr LCD_E   ; Resting state of LCD's enable is zero
006E            129       ; clr LCD_RW  ; Not used, pin tied to GND
006E            130   
006E            131       ; After power on, wait for the LCD start up time before initializing
006E 7A28       132       mov R2, #40
0070 120020     133       lcall WaitmilliSec
0073            134   
0073            135       ; First make sure the LCD is in 8-bit mode and then change to 4-bit mode
0073 7433       136       mov a, #0x33
0075 120040     137       lcall WriteCommand
0078 7433       138       mov a, #0x33
007A 120040     139       lcall WriteCommand
007D 7432       140       mov a, #0x32 ; change to 4-bit mode
007F 120040     141       lcall WriteCommand
0082            142   
0082            143       ; Configure the LCD
0082 7428       144       mov a, #0x28
0084 120040     145       lcall WriteCommand
0087 740C       146       mov a, #0x0c
0089 120040     147       lcall WriteCommand
008C 7401       148       mov a, #0x01 ;  Clear screen command (takes some time)
008E 120040     149       lcall WriteCommand
0091            150   
0091            151       ;Wait for clear screen command to finish. Usually takes 1.52ms.
0091 7A02       152       mov R2, #2
0093 120020     153       lcall WaitmilliSec
0096 22         154       ret
0097            155   
0097            156   ;---------------------------------;
0097            157   ; Main loop.  Initialize stack,   ;
0097            158   ; ports, LCD, and displays        ;
0097            159   ; letters on the LCD              ;
0097            160   ;---------------------------------;
0097            161   myprogram:
0097 75817F     162       mov SP, #7FH
009A            163       ; Configure the pins as bi-directional so we can use them as input/output
009A 75B100     164       mov P0M1, #0x00
009D 75B200     165       mov P0M2, #0x00
00A0 75B300     166       mov P1M1, #0x00
00A3 75B400     167       mov P1M2, #0x00
00A6 75AC00     168       mov P3M1, #0x00
00A9 75AD00     169       mov P3M2, #0x00
00AC            170       
00AC 12006C     171       lcall LCD_4BIT
00AF 7480       172       mov a, #0x80 ; Move cursor to line 1 column 1
00B1 120040     173       lcall WriteCommand
00B4 7444       174       mov a, #'D'
00B6 12003B     175       lcall WriteData
00B9            176       
00B9 7481       177       mov a, #0x81
00BB 120040     178       lcall WriteCommand
00BE 7461       179       mov a, #'a'
00C0 12003B     180       lcall WriteData
00C3            181       
00C3 7482       182       mov a, #0x82
00C5 120040     183       lcall WriteCommand
00C8 746E       184       mov a, #'n'
00CA 12003B     185       lcall WriteData
00CD            186       
00CD 7483       187       mov a, #0x83
00CF 120040     188       lcall WriteCommand
00D2 7469       189       mov a, #'i'
00D4 12003B     190       lcall WriteData
00D7            191       
00D7            192       
00D7 7484       193       mov a, #0x84
00D9 120040     194       lcall WriteCommand
00DC 7465       195       mov a, #'e'
00DE 12003B     196       lcall WriteData
00E1            197       
00E1 7485       198       mov a, #0x85
00E3 120040     199       lcall WriteCommand
00E6 746C       200       mov a, #'l'
00E8 12003B     201       lcall WriteData
00EB            202      
00EB 7486       203       mov a, #0x86
00ED 120040     204       lcall WriteCommand
00F0 7420       205       mov a, #' '
00F2 12003B     206       lcall WriteData
00F5            207       
00F5 7487       208       mov a, #0x87
00F7 120040     209       lcall WriteCommand
00FA 744E       210       mov a, #'N'
00FC 12003B     211       lcall WriteData
00FF            212       
00FF 7488       213       mov a, #0x88
0101 120040     214       lcall WriteCommand
0104 7467       215       mov a, #'g'
0106 12003B     216       lcall WriteData
0109            217   
0109 74C0       218       mov a, #0xC0 ; Move cursor to line 2 column 0
010B 120040     219       lcall WriteCommand
010E 7433       220       mov a, #'3'
0110 12003B     221       lcall WriteData
0113            222       
0113 74C1       223       mov a, #0xC1
0115 120040     224       lcall WriteCommand
0118 7438       225       mov a, #'8'
011A 12003B     226       lcall WriteData
011D            227       
011D 74C2       228       mov a, #0xC2
011F 120040     229       lcall WriteCommand
0122 7433       230       mov a, #'3'
0124 12003B     231       lcall WriteData
0127            232       
0127 74C3       233       mov a, #0xC3
0129 120040     234       lcall WriteCommand
012C 7432       235       mov a, #'2'
012E 12003B     236       lcall WriteData
0131            237      
0131 74C4       238       mov a, #0xC4
0133 120040     239       lcall WriteCommand
0136 7437       240       mov a, #'7'
0138 12003B     241       lcall WriteData
013B            242       
013B 74C5       243       mov a, #0xC5
013D 120040     244       lcall WriteCommand
0140 7434       245       mov a, #'4'
0142 12003B     246       lcall WriteData
0145            247       
0145 74C6       248       mov a, #0xC6
0147 120040     249       lcall WriteCommand
014A 7436       250       mov a, #'6'
014C 12003B     251       lcall WriteData
014F            252       
014F 74C7       253       mov a, #0xC7
0151 120040     254       lcall WriteCommand
0154 7436       255       mov a, #'6'
0156 12003B     256       lcall WriteData
0159            257   
0159            258   ; now that we've finished the required tasks and printing out my name, I can start polling for my switch 
0159            259   ; how about we try interrupts let's enable global interrupts and use pins 5 and 6 as hardware interrupts from our switch
0159            260   
0159 D2AF       261       setb EA
015B D2A8       262       setb EX0
015D D2AA       263       setb EX1
015F            264   
015F D288       265       setb IT0
0161 D28A       266       setb IT1
0163            267   
0163 D2B8       268       setb PX0
0165            269   
0165            270   forever:
0165 80FE       271       sjmp forever
0167            272   
0167            273   ;---------------------ISR HANDLER----------------------;
0167            274   ISR_EXT0:
0167            275   ;push data pointer high and low and accumulator and program counter to the stack
0167 C0E0       276       push ACC
0169 C0D0       277       push psw
016B C082       278       push dpl
016D C083       279       push dph
016F            280   
016F 7401       281       mov a, #0x01
0171 120040     282       lcall WriteCommand
0174 7A02       283       mov R2, #2         
0176 120020     284       lcall WaitmilliSec
0179            285   
0179 9001CF     286       mov dptr, #Mystring
017C 7B00       287       mov R3, #0       
017E            288   
017E            289   Type:
017E EB         290       mov a, R3
017F 93         291       movc a, @a+dptr    
0180 600B       292       jz done       
0182            293   
0182 12003B     294       lcall WriteData   
0185            295   
0185 7A96       296       mov R2, #150       
0187 120020     297       lcall WaitmilliSec
018A            298   
018A 0B         299       inc R3            
018B 80F1       300       sjmp Type
018D            301   
018D            302   done:
018D D083       303       pop dph
018F D082       304       pop dpl
0191 D0D0       305       pop psw
0193 D0E0       306       pop ACC
0195 32         307       reti
0196            308   
0196            309   ;-----------------------END OF ISR0-------------------------;
0196            310   
0196            311   ISR_EXT1:
0196            312   
0196 C0E0       313       push ACC
0198 C0D0       314       push psw
019A C082       315       push dpl
019C C083       316       push dph
019E            317   
019E 7401       318       mov a, #0x01        ; Clear display command
01A0 120040     319       lcall WriteCommand
01A3 7A02       320       mov R2, #2          ; Wait for clear to finish
01A5 120020     321       lcall WaitmilliSec
01A8            322   
01A8 74C0       323       mov a, #0xC0
01AA 120040     324       lcall WriteCommand
01AD 7A02       325       mov R2, #2         
01AF 120020     326       lcall WaitmilliSec
01B2            327   
01B2 9001DE     328       mov dptr, #Mystring2
01B5 7B00       329       mov R3, #0       
01B7            330   
01B7            331   Type1:
01B7 EB         332       mov a, R3
01B8 93         333       movc a, @a+dptr    
01B9 600B       334       jz done1       
01BB            335   
01BB 12003B     336       lcall WriteData   
01BE            337   
01BE 7A96       338       mov R2, #150       
01C0 120020     339       lcall WaitmilliSec
01C3            340   
01C3 0B         341       inc R3            
01C4 80F1       342       sjmp Type1
01C6            343   
01C6            344   done1:
01C6            345   
01C6 D083       346       pop dph
01C8 D082       347       pop dpl
01CA D0D0       348       pop psw
01CC D0E0       349       pop ACC
01CE 32         350       reti
01CF            351   
01CF            352   ;ISR_t0:----------------------;data----------------------;
01CF            353   Mystring:
01CF 48656C6C   354       db 'Hello ELEC291!', 0
     6F20454C
     45433239
     312100
01DE            355   
01DE            356   Mystring2:
01DE 20546869   357       db ' This is Lab 1  ', 0
     73206973
     204C6162
     20312020
     00
01EF            358   
01EF            359   
01EF            360   END
